{% extends "base.html" %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="bg-[#fffae1] rounded-lg shadow-md overflow-hidden">
        <div class="md:flex">
            
            <!-- Product Images Section -->
            <div class="md:w-1/2">
                <!-- Main Image -->
                <div class="mb-4 relative">
                    {% set discount_info = get_discount_info(product) %}
                    {% if discount_info.has_discount %}
                    <div class="absolute top-4 left-4 z-10">
                        <span class="bg-red-500 text-white px-4 py-2 rounded-full text-lg font-bold shadow-lg">
                            -{{ discount_info.discount_percent|int }}% OFF
                        </span>
                    </div>
                    {% endif %}
                    <img id="mainImage"
                    src="{{ url_for('static', filename='uploads/products/' + (product_images[0][2] if product_images else 'default-product.jpg')) }}"
                    alt="{{ product[2] }}"
                    class="w-full h-80 object-cover transition-transform duration-300 rounded-lg cursor-pointer"
                    onclick="openImageModal([{% for img in product_images %}'{{ url_for('static', filename='uploads/products/' + img[2]) }}'{% if not loop.last %}, {% endif %}{% endfor %}], 0)">

                </div>
                
                <!-- Thumbnail Images -->
                {% if product_images and product_images|length > 1 %}
                <div class="grid grid-cols-4 gap-2">
                    {% for image in product_images %}
                    <img src="{{ url_for('static', filename='uploads/products/' + image[2]) }}" 
                         alt="{{ product[2] }} - Image {{ loop.index }}"
                         class="w-full h-20 object-cover cursor-pointer border-2 {% if loop.first %}border-primary{% else %}border-transparent{% endif %} rounded-md hover:border-primary transition-all duration-200 thumbnail"
                         onclick="changeMainImage('{{ url_for('static', filename='uploads/products/' + image[2]) }}', this)">
                    {% endfor %}
                </div>
                {% endif %}
            </div>

            <!-- Product Info -->
            <div class="md:w-1/2 p-6">
                <h1 class="text-2xl font-semibold mb-4">{{ product[2] }}</h1>
                
                <!-- Price Display with Discount -->
                <div class="mb-6">
                    {% if discount_info.has_discount %}
                    <div class="space-y-3">
                        <div class="flex items-center space-x-4">
                            <span class="text-2xl text-red-600 font-bold">
                                {{ format_currency(discount_info.discounted_price) }}
                            </span>
                            <span class="text-lg text-gray-500 line-through">
                                {{ format_currency(discount_info.original_price) }}
                            </span>
                        </div>
                        <div class="flex items-center space-x-3">
                            <span class="bg-red-100 text-red-800 px-3 py-1 rounded-full text-sm font-bold border border-red-200">
                                {{ discount_info.discount_percent|int }}% Discount
                            </span>
                            <span class="text-green-600 text-sm font-semibold bg-green-50 px-2 py-1 rounded">
                                You save {{ format_currency(discount_info.you_save) }}
                            </span>
                            <br> <p class="text-red-600"> Flash sale ending soon ⭐ </p>
                        </div>
                        <div class="text-sm text-gray-600">
                            <i class="fas fa-tag text-red-500 mr-1"></i>
                            Effective price: <span class="font-semibold">{{ format_currency(discount_info.discounted_price) }}</span>
                            per item
                        </div>
                    </div>
                    {% else %}
                    <div class="space-y-2">
                        <span class="text-3xl text-primary font-bold">
                            {{ format_currency(product[4]) }}
                        </span>
                        <div class="text-sm text-gray-500">
                            <i class="fas fa-tag text-gray-400 mr-1"></i>
                            Standard pricing
                        </div>
                    </div>
                    {% endif %}
                </div>

                <!-- Availability -->
                <div class="mb-6">
                    <span class="text-gray-700 font-semibold">Availability:</span>
                    {% if product[5] > 0 %}
                        <span class="text-green-600 font-semibold ml-2">In Stock ({{ product[5] }} available)</span>
                    {% else %}
                        <span class="text-red-600 font-semibold ml-2">Out of Stock</span>
                    {% endif %}
                </div>

                <!-- Quantity & Actions -->
                {% if product[5] > 0 %}
                <div class="mb-6">
                    <label for="quantity" class="block text-gray-700 mb-2 font-semibold">Quantity:</label>
                    <div class="flex items-center space-x-2">
                        <button type="button" onclick="changeQuantity(-1)" 
                                class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300 transition duration-200 font-bold text-lg">
                            -
                        </button>
                        
                        <input type="number" id="quantity" name="quantity" value="1" min="1" max="{{ product[5] }}" 
                               class="w-20 px-3 py-2 border border-gray-300 text-center focus:outline-none focus:ring-2 focus:ring-primary font-semibold rounded-lg">
                        
                        <button type="button" onclick="changeQuantity(1)" 
                                class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300 transition duration-200 font-bold text-lg">
                            +
                        </button>
                    </div>
                    <p class="text-sm text-gray-500 mt-2">
                        <i class="fas fa-info-circle text-blue-500 mr-1"></i>
                        Maximum: {{ product[5] }} units available
                    </p>
                    
                    <div class="mt-4 p-3 bg-gray-50 rounded-lg border border-gray-200">
                        <div class="flex justify-between items-center">
                            <span class="text-gray-700 font-semibold">Total:</span>
                            <span id="totalPrice" class="text-xl font-bold text-primary">
                                {% if discount_info.has_discount %}
                                    {{ format_currency(discount_info.discounted_price) }}
                                {% else %}
                                    {{ format_currency(product[4]) }}
                                {% endif %}
                            </span>
                        </div>
                        {% if discount_info.has_discount %}
                        <div class="text-sm text-green-600 mt-1 text-right">
                            <i class="fas fa-piggy-bank mr-1"></i>
                            Save up to {{ format_currency(discount_info.you_save * product[5]) }} on bulk purchase
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- ✅ Sticky Action Buttons -->
                <div class="flex space-x-4 md:static fixed bottom-0 left-0 w-full md:w-auto bg-[#fffae1] md:bg-transparent p-3 md:p-0 shadow-[0_-2px_10px_rgba(0,0,0,0.1)] md:shadow-none z-50">
                    <!-- Add to Cart Form -->
                    <form action="{{ url_for('add_to_cart') }}" method="POST" class="inline flex-1">
                        <input type="hidden" name="product_id" value="{{ product[0] }}">
                        <input type="hidden" name="quantity" value="1" id="cartQuantity">
                        <button type="button" onclick="updateCartQuantity()" 
                                class="w-full bg-primary hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300 flex items-center justify-center space-x-2">
                            <i class="fas fa-cart-plus"></i>
                            <span>Add to Cart</span>
                        </button>
                    </form>
                    
                    <!-- Buy Now Form -->
                    <form action="{{ url_for('buy_now') }}" method="POST" class="inline flex-1">
                        <input type="hidden" name="product_id" value="{{ product[0] }}">
                        <input type="hidden" name="quantity" value="1" id="buyNowQuantity">
                        <button type="button" onclick="updateBuyNowQuantity()" 
                                class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300 flex items-center justify-center space-x-2">
                            <i class="fas fa-bolt"></i>
                            <span>Buy Now</span>
                        </button>
                    </form>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Product Details Section -->
        <div class="border-t border-gray-200 p-6">
            <div class="mb-4">
                <span class="font-semibold text-gray-700">Category:</span>
                <span class="text-gray-600 ml-2">
                    {% for category in categories %}
                        {% if category[0] == product[1] %}
                            {{ category[1] }}
                        {% endif %}
                    {% endfor %}
                </span>
            </div>
            
            <h2 class="text-xl font-semibold mb-4 text-gray-800">Product Details</h2>
            <p class="text-gray-700 mb-4 leading-relaxed">{{ product[3] }}</p>
            
            {% if discount_info.has_discount %}
            <div class="mt-6 p-4 bg-green-50 border border-green-200 rounded-lg">
                <h3 class="font-semibold text-green-800 mb-2 flex items-center">
                    <i class="fas fa-percentage mr-2"></i>
                    Special Offer
                </h3>
                <p class="text-green-700 text-sm">
                    This product is currently on sale! You're getting 
                    <span class="font-bold">{{ discount_info.discount_percent|int }}% off</span> 
                    the original price. Limited time offer!
                </p>
            </div>
            {% endif %}
        </div>
    </div>
<!-- Enhanced Image Modal (Daraz-like) -->
<div id="imageModal" class="hidden fixed inset-0 bg-black bg-opacity-80 z-[9999] flex items-center justify-center p-4">
  <div class="relative max-w-4xl w-full flex flex-col items-center">
    <!-- Close -->
    <button id="modalCloseBtn" onclick="closeImageModal()" class="absolute -top-10 right-0 text-white text-3xl font-bold">×</button>

    <!-- Prev / Next buttons -->
    <button id="prevBtn" class="absolute left-2 top-1/2 transform -translate-y-1/2 text-white text-4xl px-3 py-1 select-none">‹</button>
    <button id="nextBtn" class="absolute right-2 top-1/2 transform -translate-y-1/2 text-white text-4xl px-3 py-1 select-none">›</button>

    <!-- Main image -->
    <img id="modalImage" src="" alt="Preview" class="max-h-[80vh] rounded-lg shadow-2xl mb-4 object-contain">

    <!-- Thumbnails -->
    <div id="modalThumbnails" class="flex gap-2 mt-2 overflow-x-auto w-full px-2 justify-center">
      <!-- thumbnails injected by JS -->
    </div>
  </div>
</div>



</div>

<!-- JS for Quantity Control, Image Gallery, and Price Calculation -->
<script>
function changeQuantity(step) {
    const input = document.getElementById('quantity');
    let current = parseInt(input.value) || 1;
    let max = parseInt(input.max);
    let min = parseInt(input.min);
    let newValue = current + step;
    
    if (newValue >= min && newValue <= max) {
        input.value = newValue;
        updateTotalPrice();
    }
}

function updateTotalPrice() {
    const quantity = parseInt(document.getElementById('quantity').value) || 1;
    const unitPrice = {{ discount_info.discounted_price if discount_info.has_discount else product[4] }};
    const total = unitPrice * quantity;
    const formattedTotal = 'रु ' + total.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');
    document.getElementById('totalPrice').textContent = formattedTotal;
}

function updateCartQuantity() {
    const quantity = document.getElementById('quantity').value;
    document.getElementById('cartQuantity').value = quantity;
    document.querySelector('form[action="{{ url_for("add_to_cart") }}"]').submit();
}

function updateBuyNowQuantity() {
    const quantity = document.getElementById('quantity').value;
    document.getElementById('buyNowQuantity').value = quantity;
    document.querySelector('form[action="{{ url_for("buy_now") }}"]').submit();
}

function changeMainImage(imageSrc, element) {
    document.getElementById('mainImage').src = imageSrc;
    document.querySelectorAll('.thumbnail').forEach(thumb => {
        thumb.classList.remove('border-primary');
        thumb.classList.add('border-transparent');
    });
    element.classList.remove('border-transparent');
    element.classList.add('border-primary');
}

document.addEventListener('DOMContentLoaded', function() {
    const thumbnails = document.querySelectorAll('img[onclick*="changeMainImage"]');
    thumbnails.forEach((thumb, index) => {
        thumb.classList.add('thumbnail');
        if (index === 0) thumb.classList.add('border-primary');
        else thumb.classList.add('border-transparent');
    });
    updateTotalPrice();
    document.getElementById('quantity').addEventListener('input', updateTotalPrice);
});

document.addEventListener('keydown', function(e) {
    const quantityInput = document.getElementById('quantity');
    if (document.activeElement === quantityInput) {
        if (e.key === 'ArrowUp') { e.preventDefault(); changeQuantity(1); }
        else if (e.key === 'ArrowDown') { e.preventDefault(); changeQuantity(-1); }
    }
});
</script>
<script>
/* Modal state */
let modalIndex = 0;
let modalImages = [];

/* Open modal with an array of image URLs and start index */
function openImageModal(images, index) {
  // Fallback: if no images passed, use currently displayed mainImage src
  if (!images || images.length === 0) {
    const mainSrc = document.getElementById('mainImage')?.src;
    if (mainSrc) images = [mainSrc];
    else images = [];
  }

  modalImages = images;
  modalIndex = (typeof index === 'number' && index >= 0) ? index : 0;
  updateModalImage();
  renderModalThumbnails();
  const modal = document.getElementById('imageModal');
  if (modal) {
    modal.classList.remove('hidden');
    document.body.style.overflow = 'hidden'; // disable page scroll
  }
}

/* Close modal */
function closeImageModal() {
  const modal = document.getElementById('imageModal');
  if (modal) {
    modal.classList.add('hidden');
    document.body.style.overflow = ''; // restore scroll
  }
}

/* Update main modal image */
function updateModalImage() {
  const img = document.getElementById('modalImage');
  if (!img || modalImages.length === 0) return;
  img.src = modalImages[modalIndex];
  // update thumbnail active state (if rendered)
  const thumbs = document.querySelectorAll('#modalThumbnails img');
  thumbs.forEach((t, i) => {
    if (i === modalIndex) {
      t.classList.add('ring-2', 'ring-primary');
    } else {
      t.classList.remove('ring-2', 'ring-primary');
    }
  });
}

/* Next / Prev */
function nextImage() {
  if (modalImages.length === 0) return;
  modalIndex = (modalIndex + 1) % modalImages.length;
  updateModalImage();
}
function prevImage() {
  if (modalImages.length === 0) return;
  modalIndex = (modalIndex - 1 + modalImages.length) % modalImages.length;
  updateModalImage();
}

/* Render thumbnails inside modal */
function renderModalThumbnails() {
  const container = document.getElementById('modalThumbnails');
  if (!container) return;
  container.innerHTML = '';
  modalImages.forEach((src, i) => {
    const t = document.createElement('img');
    t.src = src;
    t.className = 'w-20 h-20 object-cover cursor-pointer rounded-md border border-transparent';
    t.style.objectFit = 'cover';
    if (i === modalIndex) t.classList.add('ring-2', 'ring-primary');
    t.addEventListener('click', () => {
      modalIndex = i;
      updateModalImage();
      renderModalThumbnails();
    });
    container.appendChild(t);
  });
}

/* DOM-ready wiring and global handlers */
document.addEventListener('DOMContentLoaded', function () {
  // prev/next buttons (may exist)
  const prev = document.getElementById('prevBtn');
  const next = document.getElementById('nextBtn');
  if (prev) prev.addEventListener('click', prevImage);
  if (next) next.addEventListener('click', nextImage);

  // close when clicking backdrop (not inside modal content)
  document.getElementById('imageModal')?.addEventListener('click', function (e) {
    if (e.target === this) closeImageModal();
  });

  // keyboard navigation
  document.addEventListener('keydown', function (e) {
    const modal = document.getElementById('imageModal');
    if (modal && !modal.classList.contains('hidden')) {
      if (e.key === 'Escape') closeImageModal();
      if (e.key === 'ArrowRight') nextImage();
      if (e.key === 'ArrowLeft') prevImage();
    }
  });
});
</script>

<style>
.thumbnail {
    transition: all 0.3s ease;
}
.thumbnail:hover {
    transform: scale(1.05);
}
#mainImage {
    transition: transform 0.3s ease;
}
#mainImage:hover {
    transform: scale(1.02);
}
.line-through {
    text-decoration: line-through;
}
/* ✅ Keep buttons visible on mobile without overlapping content */
@media (max-width: 768px) {
  body {
    padding-bottom: 90px;
  }
}
</style>
{% endblock %}
